# TiDB SMP概要设计 #
## 一、概述 ##
SMP的主要目的在于充分利用系统资源，包括计算资源、IO资源，以提高查询效率。
SMP的主要难点在于并行度的划分以及并行任务之间的数据交互。

TiDB采用算子并行的方式实现SMP，其中，由于TiDB采用GO开发语言，并行任务之间的交互不是问题。TiDB主要关注并行度的划分。

TiDB依次实现算子并行，首先实现表扫描算子（TableScan）、聚集算子（Agg）；然后实现排序算子（Sort）、连接算子（Join）等。
## 二、概要设计 ##
TiDB提供配置参数控制并行的最大数量，当参数被指定后，语句在执行时相关算子会并行执行。

算子在并行执行时需要先进行任务划分，根据数据分布情况进行平均分配。这时需要获取到表统计信息，统计信息越精确，并行任务分配的越均匀，并行执行的效率越高。

表的统计信息会定期更新，更新后的结果以等频直方图的方式保存到统计信息表中。
### 统计信息管理 ###
1.统计信息

TiDB中有表的元数据缓存，表的统计信息保存在每张表的元数据结构中，
需要修改表的结构体TableInfo，新增用于存储表中的数据的统计信息，新增字段：

- total_size	int64			//表的总大小
- histogram		string			//统计直方图

histogram是表中key值的统计直方图，采用等频的存储方式，比如某表中的key值均匀分布，从aaa-faa，histogram中的值可能是（aaa,baa,caa,daa,eaa,faa)，每相邻两个值之间的记录数基本一样。


2.统计信息更新

TiDB目前在启动时会初始化一个go routine，周期性读取表的元数据信息。在将每张表的元数据信息读取出来的时候，同时通过存储引擎接口将表的统计信息读取出来。元数据信息在重载时也会重新将表的统计信息读取出来。所以表的统计信息可能会有一些延迟，不是很准确，这个影响不大。

统计信息通过调用新增的存储接口来获取。

需要新增存储接口：

GetStatistic(t Key) ([]byte，error)

输入值：
	key ---- 表的key

返回值：
	[]byte ---- 统计信息


TiDB提供类似于HBase Coprocessor机制来触发。


### 查询计划生成与执行 ###
1.配置参数

需要添加一个配置参数：

- parallel\_max\_concurrency

并行分配的go routine的最大数量，默认0，表示不使用并行。
该参数可以动态修改。



2.计划生成与执行

对于需要实现并行的算子，在生成plan时的步骤如下：

1）判断是否需要并行

如果配置参数parallel\_max\_concurrency为0，不使用并行；
如果是索引扫描，不使用并行

否则，根据数据量判断是否需要使用并行，读取出相关表的统计信息，计算需要扫描的数据量，如果数据量小于parallel\_region\_size，不使用并行。

2）计算并行度

在确定算子需要并行执行后，计算并行度的步骤如下：

1. 读取簇表的所有Region相关信息
2. 依次根据Region信息按照parallel\_region\_size大小进行扫描区间的切分，将扫描区间切分成很多小份
3. 根据parallel\_max\_concurrency的将将扫描区间组合成不超过parallel\_max\_concurrency份
4. 根据最终的划分数启动相应个数的go routine，将划分的任务分别指派给新routine执行，执行的结果传到指定的channel中
5. 新启动的go routine在执行完毕后执行退出
6. 主执行节点不断从指定channel中读取数据，直到所有数据读取完毕

# 参考资料 #
[https://github.com/forcedotcom/phoenix/issues/49](https://github.com/forcedotcom/phoenix/issues/49)